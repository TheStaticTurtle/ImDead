from flask import Flask
from flask import request, render_template
from os import path
import os
import base64

def getEnvVarDefault(var_name, default):
	x = os.environ.get(var_name)
	return x if x else default

TEMPLATE_ROOT = "websites/" #Manage this with docker volumes

HOMEPAGE = getEnvVarDefault("IMDEAD_HOMEPAGE","https://thestaticturtle.fr")
DEFAUT_TEMPLATE = getEnvVarDefault("IMDEAD_DEFAULT_TEMPALTE","default.html")
RESPONSE_CODE = int(getEnvVarDefault("IMDEAD_RESPONSE_CODE",503))

if not path.exists(TEMPLATE_ROOT):
	os.mkdir(TEMPLATE_ROOT)

if not path.exists(path.join(TEMPLATE_ROOT,DEFAUT_TEMPLATE)):
	with open(path.join(TEMPLATE_ROOT,DEFAUT_TEMPLATE), "wb") as f:
		f.write(base64.b64decode("PGh0bWwgbGFuZz0iZW4iIGRhdGEtbHQtaW5zdGFsbGVkPSJ0cnVlIj4KCTxoZWFkPgoJCTxtZXRhIGNoYXJzZXQ9InV0Zi04Ij4KCQk8bWV0YSBodHRwLWVxdWl2PSJYLVVBLUNvbXBhdGlibGUiIGNvbnRlbnQ9IklFPWVkZ2UiPgoJCTxtZXRhIG5hbWU9InZpZXdwb3J0IiBjb250ZW50PSJ3aWR0aD1kZXZpY2Utd2lkdGgsIGluaXRpYWwtc2NhbGU9MSI+CgkJPHRpdGxlPjUwMyBXZWJzaXRlIGRpc2FibGVkPC90aXRsZT4KCQk8bGluayByZWw9InByZWNvbm5lY3QiIGhyZWY9Imh0dHBzOi8vZm9udHMuZ29vZ2xlYXBpcy5jb20iPgoJCTxsaW5rIHJlbD0icHJlY29ubmVjdCIgaHJlZj0iaHR0cHM6Ly9mb250cy5nc3RhdGljLmNvbSIgY3Jvc3NvcmlnaW4+CgkJPGxpbmsgaHJlZj0iaHR0cHM6Ly9mb250cy5nb29nbGVhcGlzLmNvbS9jc3MyP2ZhbWlseT1DYWJpbjp3Z2h0QDQwMDs3MDAmZGlzcGxheT1zd2FwIiByZWw9InN0eWxlc2hlZXQiPgoJCTxzdHlsZT4KCQkJKiB7CgkJCQktd2Via2l0LWJveC1zaXppbmc6IGJvcmRlci1ib3g7CgkJCQlib3gtc2l6aW5nOiBib3JkZXItYm94CgkJCX0KCgkJCWJvZHkgewoJCQkJcGFkZGluZzogMDsKCQkJCW1hcmdpbjogMAoJCQl9CgoJCQkjZGlzYWJsZWQgewoJCQkJcG9zaXRpb246IHJlbGF0aXZlOwoJCQkJaGVpZ2h0OiAxMDB2aAoJCQl9CgoJCQkjZGlzYWJsZWQgLmRpc2FibGVkIHsKCQkJCXBvc2l0aW9uOiBhYnNvbHV0ZTsKCQkJCWxlZnQ6IDUwJTsKCQkJCXRvcDogNTAlOwoJCQkJLXdlYmtpdC10cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKCQkJCS1tcy10cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKCQkJCXRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpCgkJCX0KCgkJCS5kaXNhYmxlZCB7CgkJCQltYXgtd2lkdGg6IDQ2MHB4OwoJCQkJd2lkdGg6IDEwMCU7CgkJCQl0ZXh0LWFsaWduOiBjZW50ZXI7CgkJCQlsaW5lLWhlaWdodDogMS40CgkJCX0KCgkJCS5kaXNhYmxlZCAuZGlzYWJsZWQtNTAzIHsKCQkJCXBvc2l0aW9uOiByZWxhdGl2ZTsKCQkJCXdpZHRoOiAxODBweDsKCQkJCWhlaWdodDogMTgwcHg7CgkJCQltYXJnaW46IDAgYXV0byA1MHB4CgkJCX0KCgkJCS5kaXNhYmxlZCAuZGlzYWJsZWQtNTAzPmRpdjpmaXJzdC1jaGlsZCB7CgkJCQlwb3NpdGlvbjogYWJzb2x1dGU7CgkJCQlsZWZ0OiAwOwoJCQkJcmlnaHQ6IDA7CgkJCQl0b3A6IDA7CgkJCQlib3R0b206IDA7CgkJCQliYWNrZ3JvdW5kOiAjZmZhMjAwOwoJCQkJLXdlYmtpdC10cmFuc2Zvcm06IHJvdGF0ZSg0NWRlZyk7CgkJCQktbXMtdHJhbnNmb3JtOiByb3RhdGUoNDVkZWcpOwoJCQkJdHJhbnNmb3JtOiByb3RhdGUoNDVkZWcpOwoJCQkJYm9yZGVyOiA1cHggZGFzaGVkICMwMDA7CgkJCQlib3JkZXItcmFkaXVzOiA1cHgKCQkJfQoKCQkJLmRpc2FibGVkIC5kaXNhYmxlZC01MDM+ZGl2OmZpcnN0LWNoaWxkOmJlZm9yZSB7CgkJCQljb250ZW50OiAnJzsKCQkJCXBvc2l0aW9uOiBhYnNvbHV0ZTsKCQkJCWxlZnQ6IC01cHg7CgkJCQlyaWdodDogLTVweDsKCQkJCWJvdHRvbTogLTVweDsKCQkJCXRvcDogLTVweDsKCQkJCS13ZWJraXQtYm94LXNoYWRvdzogMCAwIDAgNXB4IHJnYmEoMCwgMCwgMCwgLjEpIGluc2V0OwoJCQkJYm94LXNoYWRvdzogMCAwIDAgNXB4IHJnYmEoMCwgMCwgMCwgLjEpIGluc2V0OwoJCQkJYm9yZGVyLXJhZGl1czogNXB4CgkJCX0KCgkJCS5kaXNhYmxlZCAuZGlzYWJsZWQtNTAzIGgxIHsKCQkJCWZvbnQtZmFtaWx5OiBjYWJpbiwgc2Fucy1zZXJpZjsKCQkJCWNvbG9yOiAjMDAwOwoJCQkJZm9udC13ZWlnaHQ6IDcwMDsKCQkJCW1hcmdpbjogMDsKCQkJCWZvbnQtc2l6ZTogOTBweDsKCQkJCXBvc2l0aW9uOiBhYnNvbHV0ZTsKCQkJCXRvcDogNTAlOwoJCQkJLXdlYmtpdC10cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKCQkJCS1tcy10cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKCQkJCXRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwoJCQkJbGVmdDogNTAlOwoJCQkJdGV4dC1hbGlnbjogY2VudGVyOwoJCQkJaGVpZ2h0OiA0MHB4OwoJCQkJbGluZS1oZWlnaHQ6IDQwcHgKCQkJfQoKCQkJLmRpc2FibGVkIGgyIHsKCQkJCWZvbnQtZmFtaWx5OiBjYWJpbiwgc2Fucy1zZXJpZjsKCQkJCWZvbnQtc2l6ZTogMzNweDsKCQkJCWZvbnQtd2VpZ2h0OiA3MDA7CgkJCQl0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOwoJCQkJbGV0dGVyLXNwYWNpbmc6IDdweAoJCQl9CgoJCQkuZGlzYWJsZWQgaDMgewoJCQkJZm9udC1mYW1pbHk6IGNhYmluLCBzYW5zLXNlcmlmOwoJCQkJZm9udC1zaXplOiAyNXB4OwoJCQkJZm9udC13ZWlnaHQ6IDcwMDsKCQkJCXRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CgkJCQlsZXR0ZXItc3BhY2luZzogM3B4CgkJCX0KCgkJCS5kaXNhYmxlZCBwIHsKCQkJCWZvbnQtZmFtaWx5OiBjYWJpbiwgc2Fucy1zZXJpZjsKCQkJCWZvbnQtc2l6ZTogMTZweDsKCQkJCWNvbG9yOiAjMDAwOwoJCQkJZm9udC13ZWlnaHQ6IDQwMAoJCQl9CgoJCQkuZGlzYWJsZWQgYSB7CgkJCQlmb250LWZhbWlseTogY2FiaW4sIHNhbnMtc2VyaWY7CgkJCQlkaXNwbGF5OiBpbmxpbmUtYmxvY2s7CgkJCQlwYWRkaW5nOiAxMHB4IDI1cHg7CgkJCQliYWNrZ3JvdW5kLWNvbG9yOiAjOGY4ZjhmOwoJCQkJYm9yZGVyOiBub25lOwoJCQkJYm9yZGVyLXJhZGl1czogNDBweDsKCQkJCWNvbG9yOiAjZmZmOwoJCQkJZm9udC1zaXplOiAxNHB4OwoJCQkJZm9udC13ZWlnaHQ6IDcwMDsKCQkJCXRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CgkJCQl0ZXh0LWRlY29yYXRpb246IG5vbmU7CgkJCQktd2Via2l0LXRyYW5zaXRpb246IC4ycyBhbGw7CgkJCQl0cmFuc2l0aW9uOiAuMnMgYWxsCgkJCX0KCgkJCS5kaXNhYmxlZCBhOmhvdmVyIHsKCQkJCWJhY2tncm91bmQtY29sb3I6ICMyYzJjMmMKCQkJfQoJCTwvc3R5bGU+CgkJPG1ldGEgbmFtZT0icm9ib3RzIiBjb250ZW50PSJub2luZGV4LCBmb2xsb3ciPgoJPC9oZWFkPgoJPGJvZHk+CgkJPGRpdiBpZD0iZGlzYWJsZWQiPgoJCQk8ZGl2IGNsYXNzPSJkaXNhYmxlZCI+CgkJCQk8ZGl2IGNsYXNzPSJkaXNhYmxlZC01MDMiPgoJCQkJCTxkaXY+PC9kaXY+CgkJCQkJPGgxPjUwMzwvaDE+CgkJCQk8L2Rpdj4KCQkJCTxoMz57eyBkb21haW4gfX08L2gzPgoJCQkJPGgyPkhhcyBiZWVuIGRpc2FibGVkPC9oMj4KCQkJCTxwPkl0IGFwcGVhcnMgdGhhdCB0aGUgd2Vic2l0ZSB5b3UgYXJlIHRyeWluZyB0byB2aXNpdCBoYXMgYmVlbiBkaXNhYmxlZCBieSB0aGUgYWRtaW5pc3RyYXRvciBpdCBtaWdodCBiZSB0ZW1wb3Jhcnkgb3IgZGVmaW5pdGl2ZSwgdGhpcyBlcnJvciBpcyBub3JtYWwuIEluIHRoZSBtZWFudGltZSB5b3UgY2FuIGdvIGJhY2sgdG8gdGhlIGhvbWVwYWdlIGJ5IGNsaWNraW5nIG9uIHRoZSBidXR0b24gYmVsbG93PC9wPgoJCQkJPGEgaHJlZj0ie3sgaG9tZXBhZ2UgfX0iPmhvbWUgcGFnZTwvYT4KCQkJPC9kaXY+CgkJPC9kaXY+Cgk8L2JvZHk+CjwvaHRtbD4="))

app = Flask(__name__, template_folder=TEMPLATE_ROOT)

@app.route("/favicon.ico")
def actually_a_404():
	return "404, Not found",404

@app.route("/")
@app.route("/<path:_path>")
def catch_all(_path=""):
	temlate = DEFAUT_TEMPLATE
	domain = request.headers['Host']
	potential_template = domain + ".html"

	if path.exists(path.join(TEMPLATE_ROOT,potential_template)):
		print("Found custom template for: "+domain)
		temlate = potential_template
	else:
		print("Keeping default template for: "+domain)

	return render_template(temlate,
		homepage=HOMEPAGE,
		domain=domain,
		domain_path=_path,
		useragent=request.headers['User-Agent'],
	), RESPONSE_CODE


